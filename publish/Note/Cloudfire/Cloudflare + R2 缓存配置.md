---
tags:
TODO:
public: true
star:
AIGC: true
---
# 1. 📝 Cloudflare + R2 缓存配置

## 1.1. 核心概念速查

### 1.1.1. ☁️ 小黄云 (Proxy Status)
- **橙色 (Proxied)**：流量经过 Cloudflare。**必须开启**，缓存规则才会生效。
- **灰色 (DNS Only)**：直连源站。缓存规则**无效**。
- **作用**：开启橙色云朵后，Cloudflare 才能作为“中间商”拦截请求，保护你的 R2 钱包。

### 1.1.2. ⏱️ 两种 TTL (生存时间)

- **边缘 TTL (Edge TTL)**：**给 Cloudflare 看的**。
    - 决定文件在 Cloudflare 服务器存多久。
    - **作用**：直接省钱。时间越长，回源 R2 的次数越少。
- **浏览器 TTL (Browser TTL)**：**给用户浏览器看的**。
    - 决定文件在用户本地硬盘存多久。
    - **作用**：极致速度 (秒开)。但设置太长会导致用户无法立刻看到更新。

### 1.1.3. 💰 为什么这样能省钱？

- **R2 计费模式**：免流量费 (Zero Egress)，但收“操作费” (Class B请求)。
- **省钱逻辑**：开启缓存 -> 请求被 Cloudflare 拦截并返回 -> R2 收不到请求 -> **费用为 0**。
- **AWS 对比**：AWS 收取高昂的“出口流量费” (数据绑架)，R2 不收流量费，适合做图床。

---

## 1.2. 场景化配置方案 (Best Practices)

建议拆分为两条独立的 **Cache Rules (缓存规则)**。

### 1.2.1. 🖼️ 场景 A：图床/静态资源 (Immutable)

- **适用域名**：`file`、`share` (图片、压缩包等)
- **特点**：文件一旦上传**不修改**，更新时会**改文件名** (如 `v1.jpg` -> `v2.jpg`)。
- **配置建议**：
    - **匹配规则**：主机名 (Hostname) 等于 `file.quaternijkon.online`
    - **边缘 TTL (Edge)**：**1 个月** (拉满，最大程度省钱)。
    - **浏览器 TTL (Browser)**：**7 天** (或 1 天，用户体验极佳，无网络请求)。
    - **特殊开关**：“重新验证时提供过时内容” -> **关闭** (保持默认)。
        

### 1.2.2. 📝 场景 B：源码/文档 (Mutable)

- **适用域名**：`markdown` (经常变动的 .md 文件)
- **特点**：文件名不变，但**内容会更新**，且希望用户能较快看到新版。
- **配置建议**：
    - **匹配规则**：主机名 (Hostname) 等于 `markdown.quaternijkon.online`
    - **边缘 TTL (Edge)**：**2 小时** (平衡点：挡住爆发流量，半天内自动更新)。
    - **浏览器 TTL (Browser)**：**绕过缓存 (Bypass)** (强制浏览器每次都问 Cloudflare，防止用户端死锁)。

### 1.2.3. 🏠 场景 C：主博客 (HTML)

- **适用域名**：`quaternijkon.online` (GitHub Pages)
- **策略**：**不配置规则** (或仅开小橙云但不设缓存)。
- **理由**：流量费由 GitHub 承担，不需要省钱，优先保证发布文章后的实时性。

---

## 1.3. 常见疑问与坑点 (FAQ)

### 1.3.1. Q1: “重新验证时提供过时内容”要开吗？

- **不要开**。对于不可变文件（图片），开了会让用户白白等待一次验证请求；关了能保持“秒开”，且后台会自动更新缓存。

### 1.3.2. Q2: 用户点击“下载”会怎么样？

- 浏览器通常会**忽略**本地缓存，强制发起请求。
- **但是**：请求会被 Cloudflare 的 **Edge Cache** 挡住。只要 Edge TTL 没过期，**R2 依然不扣费**。

### 1.3.3. Q3: 为什么部署规则时报错 `API Request Failed`？

- **原因**：通常是浏览器的**广告拦截插件**或隐私插件误杀了 Cloudflare 的请求。
- **解法**：使用**无痕模式** (Incognito Mode) 重新操作。

### 1.3.4. Q4: 缓存没命中 (Cache Miss) 会怎样？

- Cloudflare 会回源去 R2 拿一次文件。
- **代价**：消耗 **1 次** R2 操作额度（几乎免费），然后该文件会被缓存起来。

### 1.3.5. Q5: 我发错文件了怎么办？

- **核武器**：去 Cloudflare 后台 -> 缓存 -> 配置 -> **自定义清除 (Custom Purge)**。
- **输入 URL**：只清除那个错文件的缓存，不要点“清除所有”，否则全站回源会浪费 R2 额度。